# Docker 部署

Dict-Hub 提供官方 Docker 镜像，支持一键部署。

## 快速开始

使用以下命令快速启动：

```bash
docker run -d \
  --name dict-hub \
  -p 8080:8080 \
  -v ./dicts:/app/dicts \
  -v ./data:/app/data \
  dongdonghe122/dict-hub:latest
```

启动后访问 `http://localhost:8080` 即可使用。

## 使用 Docker Compose（推荐）

创建 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  dict-hub:
    image: dongdonghe122/dict-hub:latest
    container_name: dict-hub
    ports:
      - "8080:8080"
    volumes:
      # SQLite 数据库持久化
      - ./data:/app/data
      # 词典文件目录
      - ./dicts:/app/dicts
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
```

启动服务：

```bash
docker-compose up -d
```

## 目录结构

部署前请准备以下目录结构：

```
./
├── docker-compose.yml
├── data/                  # 数据库文件（自动创建）
└── dicts/
    ├── source/            # MDX 词典文件
    │   ├── 牛津高阶.mdx
    │   └── 朗文当代.mdx
    └── sound/             # MDD 音频文件
        └── 牛津发音.mdd
```

## 环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `SERVER_PORT` | `8080` | 服务端口 |
| `SERVER_MODE` | `production` | 运行模式 |
| `DATABASE_PATH` | `/app/data/dictionary.db` | 数据库路径 |
| `MDX_DICT_DIR` | `/app/dicts` | 词典根目录 |
| `MDX_SOURCE_DIR` | `/app/dicts/source` | MDX 文件目录 |
| `MDX_SOUND_DIR` | `/app/dicts/sound` | MDD 文件目录 |
| `MDX_AUTO_LOAD` | `true` | 启动时自动加载词典 |
| `TZ` | `Asia/Shanghai` | 时区设置 |

## 版本说明

镜像采用语义化版本号：

- `latest` - 最新稳定版本
- `x.x.x` - 指定版本号（如 `1.0.0`）

查看所有可用版本：[Docker Hub](https://hub.docker.com/r/dongdonghe122/dict-hub/tags)

## 更新镜像

```bash
# 拉取最新镜像
docker pull dongdonghe122/dict-hub:latest

# 重启容器
docker-compose down
docker-compose up -d
```

## 查看日志

```bash
# 实时查看日志
docker logs -f dict-hub

# 查看最近 100 行
docker logs --tail 100 dict-hub
```

## 健康检查

容器内置健康检查，可通过以下命令查看状态：

```bash
docker inspect --format='{{.State.Health.Status}}' dict-hub
```

或访问健康检查接口：

```bash
curl http://localhost:8080/health
```

## 常见问题

### 词典未显示

1. 检查词典文件是否放在正确目录
2. 确认 MDX 文件格式正确
3. 查看日志排查加载错误

```bash
docker logs dict-hub | grep -i "error\|mdx"
```

### 端口被占用

修改 `docker-compose.yml` 中的端口映射：

```yaml
ports:
  - "9090:8080"  # 改为其他端口
```

### 权限问题

确保词典目录有正确的读取权限：

```bash
chmod -R 755 ./dicts
```
